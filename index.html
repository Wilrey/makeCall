<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genesys Cloud API Demo</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>

<h1>Genesys Cloud API Demo</h1>

<table border="1">
<tbody id="queueData"></tbody>
</table>

<button onclick="refreshData()">Refresh Data</button>

<script>
  const CLIENT_ID = '50999a4b-409c-4846-a249-4357e0e293a5';
  const ENVIRONMENT = 'mypurecloud.de';
  const API_ENDPOINT = 'https://api.mypurecloud.de/api/v2/analytics/queues/observations/query';
  const REDIRECT_URI = 'https://wilrey.github.io/test/index.html';

  const queues = {
    "72889920-75ef-41d9-bc09-6fa8d402963f": { name: "SI24_PAT-PRESTACIONES_ESSD0206" },
    "a9aa307e-9683-4403-b7b5-db3cf1156cca": { name: "SI24_AUT-ASISTENCIAVIAJE_ESSD0201" },
    "72937585-4272-420d-b7fc-dd271853615a": { name: "SI24_AUT-GESTCARTERA_ESSD0301" },
    "5fd9379a-edff-4c1b-bf95-e2bc4252fb9e": { name: "SI24_PAT-GESTCARTERA_ESSD0301" },
    "02898175-6c56-4032-afd3-60e3351d19ee": { name: "SI24_AUT-PRESTACIONES_ESSD0205" },
    "816bab0a-860b-4465-89b0-c12cc57a1a1f": { name: "SI24_SAL-PRESTACIONES_ESSD0203" },
    "e163a627-66b9-49f5-ba4a-a10c72856187": { name: "SI24_VER-GESTCARTERAAUT_ESSD0301" },
    "1d8dd444-f8f8-4767-a73e-a64c4f125f46": { name: "STT_MIX_AUTOS_ESSD8601" },
    "592cc651-2aac-4a11-a1ec-12dd7ffb8cb9": { name: "SI24_FILIAL-MAPFRE_ESSD9999" },
    "857e77a5-0946-4d53-8c6d-8c017afaca87": { name: "SI24_AUT-RETENCION_ESSD0105" },
    "726a2b95-64ee-4745-b44a-52798e529214": { name: "AGR_AUTOS_ESSD9999" },
    "cb88a966-9763-48f4-91d3-594b38d91ce3": { name: "CMP_COV_BGP_ESSD8401" },
    "8be4f3fd-cc07-49f2-86a1-54d2206ea7c0": { name: "CST_CORREDORES_ESSD8701" },
    "163c087f-b050-4fa7-b8dd-c4b005c7df37": { name: "CRA_INT_ESSD9999" },
    "4d4c928b-dac8-4dd6-bccd-7450c5936c15": { name: "CRR_MKT_RECIBOSSANTANDER_ESSD9999" }
};

  const predicates = Object.keys(queues).map(queueId => ({
  dimension: "queueId",
  value: queueId
}));
  const requestData = {
    metrics: [
      "oWaiting",
      "oInteracting",
      "oAlerting",
      "oMemberUsers",
      "oActiveUsers",
      "oOnQueueUsers",
      "oOffQueueUsers"
    ],
    filter: {
      type: "and",
      clauses: [
        {
          type: "or",
          predicates: predicates
        }
      ]
    },
    detailMetrics: [
      "oWaiting",
      "oInteracting"
    ]
  };

  function getParameterByName(name) {
    name = name.replace(/[\\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
      results = regex.exec(location.hash);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadData() {
    var token = getParameterByName('access_token');

    $.ajax({
      url: API_ENDPOINT,
      type: 'POST',
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      },
      data: JSON.stringify(requestData),
      contentType: 'application/json',
      success: function(data) {
        displayData(data);
      }
    });
  }

function displayData(data) {
  const queueData = $("#queueData");
  queueData.empty();

  if (data.results && Array.isArray(data.results)) {
    // Sort results by Queue ID and then by MediaType
    const sortedResults = data.results.sort((a, b) => {
      const queueIdComparison = a.group.queueId.localeCompare(b.group.queueId);
      if (queueIdComparison !== 0) {
        return queueIdComparison;
      }

      // Filter out undesired media types
      const undesiredMediaTypes = ["message", "chat", "email"];
      if (undesiredMediaTypes.includes(a.group.mediaType) || undesiredMediaTypes.includes(b.group.mediaType)) {
        return 0; // Equal for undesired media types, maintaining the order within the same queue
      }

      return (a.group.mediaType || '').localeCompare(b.group.mediaType || '');
    });

    // Display header with Queue ID and MediaType columns
    const headerRow = `<tr>
                        <th>Queue ID</th>
                        <th>Media Type</th>
                        <th>Interacting</th>
                        <th>Waiting</th>
                        <th>Alerting</th>
                        <th>Member Users</th>
                        <th>Longest Waiting</th>
                      </tr>`;
    queueData.append(headerRow);

    // Render sorted results
    sortedResults.forEach(result => {
      const group = result.group;
      const dataItems = result.data;

      const mediaType = group.mediaType || ''; // Handle cases where mediaType might be undefined

      const longestWaitingDate = getObservationDate(dataItems);

      const row = `<tr>
                    <td>${queues[group.queueId].name}</td>
                    <td>${mediaType}</td>
                    <td>${getMetricValue(dataItems, "oInteracting")}</td>
                    <td>${getMetricValue(dataItems, "oWaiting")}</td>
                    <td>${getMetricValue(dataItems, "oAlerting")}</td>
                    <td>${getMetricValue(dataItems, "oMemberUsers")}</td>
                    <td>${longestWaitingDate}</td>
                  </tr>`;
      queueData.append(row);
    });
  } else if (data.observations && Array.isArray(data.observations)) {
    // Display header for notifications payload
    const headerRow = `<tr>
                        <th>Media Type</th>
                        <th>Longest Waiting</th>
                        <th>Conversation ID</th>
                        <th>Session ID</th>
                        <th>User ID</th>
                      </tr>`;
    queueData.append(headerRow);

    // Render observations for notifications payload
    data.observations.forEach(observation => {
      const row = `<tr>
                    <td>${observation.mediaType || ''}</td>
                    <td>${observation.observationDate}</td>
                    <td>${observation.conversationId}</td>
                    <td>${observation.sessionId}</td>
                    <td>${observation.userId}</td>
                  </tr>`;
      queueData.append(row);
    });
  } else {
    console.error('Invalid response format:', data);
  }
}

function getObservationDate(dataItems) {
  const waitingData = dataItems.find(item => item.metric === "oWaiting");
  if (waitingData && waitingData.observations && waitingData.observations.length > 0) {
    return waitingData.observations[0].observationDate;
  }
  return '';
}
  
function getMetricValue(dataItems, metricName) {
  const metricData = dataItems.find(item => item.metric === metricName);
  return metricData ? metricData.stats.count : 0;
}

  function refreshData() {
    loadData();
  }

  
  console.log("HOLA");
// Check if there is a hash in the URL
if (window.location.hash) {
  const token = getParameterByName('access_token');
  console.log("token" + token);
  loadData();
} else {
  console.log("REDIRECT_URI: " + REDIRECT_URI);
  const queryStringData = {
    response_type: "token",
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI
  };
  window.location.replace(`https://login.${ENVIRONMENT}/oauth/authorize?` + jQuery.param(queryStringData));
}

</script>

</body>
</html>
