<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genesys Cloud API Demo</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>

<h1>Genesys Cloud API Demo</h1>

<table border="1">
<tbody id="queueData"></tbody>
</table>

<button onclick="refreshData()">Refresh Data</button>

<script>
  const CLIENT_ID = 'ee4696b8-16c4-40ce-87ae-7322597880ac';
  const ENVIRONMENT = 'mypurecloud.de';
  const API_ENDPOINT = 'https://api.mypurecloud.de/api/v2/analytics/queues/observations/query';
  const REDIRECT_URI = 'https://wilrey.github.io/test/index.html';

  const requestData = {
    metrics: [
      "oWaiting",
      "oInteracting",
      "oAlerting",
      "oMemberUsers",
      "oActiveUsers",
      "oOnQueueUsers",
      "oOffQueueUsers"
    ],
    filter: {
      type: "and",
      clauses: [
        {
          type: "or",
          predicates: [
            {
              dimension: "queueId",
              value: "47bfab0c-4a64-4689-b307-aab540680985"
            },
            {
              dimension: "queueId",
              value: "b2231d1f-21ca-435b-81fa-6665b3e3dfd6"
            }
          ]
        }
      ]
    },
    detailMetrics: [
      "oWaiting",
      "oInteracting"
    ]
  };

  function getParameterByName(name) {
    name = name.replace(/[\\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
      results = regex.exec(location.hash);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadData() {
    var token = getParameterByName('access_token');

    $.ajax({
      url: API_ENDPOINT,
      type: 'POST',
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      },
      data: JSON.stringify(requestData),
      contentType: 'application/json',
      success: function(data) {
        displayData(data);
      }
    });
  }

function displayData(data) {
  const queueData = $("#queueData");
  queueData.empty();

  if (data.results && Array.isArray(data.results)) {
    // Sort results by Queue ID and then by MediaType
    const sortedResults = data.results.sort((a, b) => {
      const queueIdComparison = a.group.queueId.localeCompare(b.group.queueId);
      if (queueIdComparison !== 0) {
        return queueIdComparison;
      }
      return (a.group.mediaType || '').localeCompare(b.group.mediaType || '');
    });

    // Display header with Queue ID and MediaType columns
    const headerRow = `<tr>
                        <th>Queue ID</th>
                        <th>Media Type</th>
                        <th>Interacting</th>
                        <th>Waiting</th>
                        <th>Alerting</th>
                        <th>Member Users</th>
                        <th>Longest Waiting</th>
                      </tr>`;
    queueData.append(headerRow);

    // Render sorted results
    sortedResults.forEach(result => {
      const group = result.group;
      const dataItems = result.data;

      const mediaType = group.mediaType || ''; // Handle cases where mediaType might be undefined

      const longestWaitingDate = getObservationDate(dataItems);

      const row = `<tr>
                    <td>${group.queueId}</td>
                    <td>${mediaType}</td>
                    <td>${getMetricValue(dataItems, "oInteracting")}</td>
                    <td>${getMetricValue(dataItems, "oWaiting")}</td>
                    <td>${getMetricValue(dataItems, "oAlerting")}</td>
                    <td>${getMetricValue(dataItems, "oMemberUsers")}</td>
                    <td>${longestWaitingDate}</td>
                  </tr>`;
      queueData.append(row);
    });
  } else if (data.observations && Array.isArray(data.observations)) {
    // Display header for notifications payload
    const headerRow = `<tr>
                        <th>Media Type</th>
                        <th>Longest Waiting</th>
                        <th>Conversation ID</th>
                        <th>Session ID</th>
                        <th>User ID</th>
                      </tr>`;
    queueData.append(headerRow);

    // Render observations for notifications payload
    data.observations.forEach(observation => {
      const row = `<tr>
                    <td>${observation.mediaType || ''}</td>
                    <td>${observation.observationDate}</td>
                    <td>${observation.conversationId}</td>
                    <td>${observation.sessionId}</td>
                    <td>${observation.userId}</td>
                  </tr>`;
      queueData.append(row);
    });
  } else {
    console.error('Invalid response format:', data);
  }
}


function getObservationDate(dataItems) {
  const waitingData = dataItems.find(item => item.metric === "oWaiting");
  if (waitingData && waitingData.observations && waitingData.observations.length > 0) {
    return waitingData.observations[0].observationDate;
  }
  return '';
}
  
function getMetricValue(dataItems, metricName) {
  const metricData = dataItems.find(item => item.metric === metricName);
  return metricData ? metricData.stats.count : 0;
}

  function refreshData() {
    loadData();
  }

  
  console.log("HOLA");
// Check if there is a hash in the URL
if (window.location.hash) {
  const token = getParameterByName('access_token');
  console.log("token" + token);
  loadData();
} else {
  console.log("REDIRECT_URI: " + REDIRECT_URI);
  const queryStringData = {
    response_type: "token",
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI
  };
  window.location.replace(`https://login.${ENVIRONMENT}/oauth/authorize?` + jQuery.param(queryStringData));
}

</script>

</body>
</html>
