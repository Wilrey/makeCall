<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genesys Cloud API Demo</title>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>

<h1>Genesys Cloud API Demo</h1>

<table border="1">
  <thead>
    <tr>
      <th>Queue Name</th>
      <th>Interactions</th>
      <th>Waiting</th>
      <th>Longest Waiting</th>
      <th>Agents in Queue</th>
    </tr>
  </thead>
  <tbody id="queueData"></tbody>
</table>

<button onclick="refreshData()">Refresh Data</button>

<script>
  const CLIENT_ID = 'ee4696b8-16c4-40ce-87ae-7322597880ac';
  const ENVIRONMENT = 'mypurecloud.de';
  const API_ENDPOINT = 'https://api.mypurecloud.de/api/v2/analytics/queues/observations/query';
  const REDIRECT_URI = 'https://wilrey.github.io/test/index.html';

  const requestData = {
    metrics: [
      "oWaiting",
      "oInteracting",
      "oAlerting",
      "oMemberUsers",
      "oActiveUsers",
      "oOnQueueUsers",
      "oOffQueueUsers"
    ],
    filter: {
      type: "and",
      clauses: [
        {
          type: "or",
          predicates: [
            {
              dimension: "queueId",
              value: "47bfab0c-4a64-4689-b307-aab540680985"
            },
            {
              dimension: "queueId",
              value: "b2231d1f-21ca-435b-81fa-6665b3e3dfd6"
            }
          ]
        }
      ]
    },
    detailMetrics: [
      "oWaiting",
      "oInteracting"
    ]
  };

  function getParameterByName(name) {
    name = name.replace(/[\\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
      results = regex.exec(location.hash);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadData() {
    var token = getParameterByName('access_token');

    $.ajax({
      url: API_ENDPOINT,
      type: 'POST',
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      },
      success: function(data) {
        displayData(data);
      }
    });
  }

  function displayData(data) {
    const queueData = $("#queueData");
    queueData.empty();

    data.forEach(queue => {
      const row = `<tr>
                    <td>${queue.queueName}</td>
                    <td>${queue.interactions}</td>
                    <td>${queue.waiting}</td>
                    <td>${queue.longestWaiting}</td>
                    <td>${queue.agentsInQueue}</td>
                  </tr>`;
      queueData.append(row);
    });
  }

  function refreshData() {
    loadData();
  }

  
  console.log("HOLA");
// Check if there is a hash in the URL
if (window.location.hash) {
  const token = getParameterByName('access_token');
  console.log("token" + token);
  loadData();
} else {
  console.log("REDIRECT_URI: " + REDIRECT_URI);
  const queryStringData = {
    response_type: "token",
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI
  };
  window.location.replace(`https://login.${ENVIRONMENT}/oauth/authorize?` + jQuery.param(queryStringData));
}

</script>

</body>
</html>
